<template>
  <div id="installer">
    <div class="generic-page" id="installer-container">
      <h1>{{ t('installer.title') }}</h1>
      <div class="installer">
        <div id="status-display"></div>
        <button id="btn-connect">
          {{ t('installer.connect') }}
        </button>
        <button id="btn-recovery">
          {{ t('installer.recovery') }}
        </button>
        <form hidden id="install-form">
          <label for="input-restore">{{ t('installer.restore') }}:</label>
          <input
            checked
            type="checkbox"
            name="input-uname"
            id="input-restore"
          />
          <label for="input-uname">{{ t('installer.username') }}:</label>
          <input
            maxlength="16"
            type="text"
            name="input-uname"
            id="input-uname"
          />
          <button type="button" id="btn-disconnect">
            {{ t('installer.disconnect') }}
          </button>
          <button id="btn-install" class="btn-primary" type="submit">
            {{ t('installer.install') }}
          </button>
        </form>
        <div id="done-msg" hidden>
          <span id="thanks"> {{ t('installer.thanks') }}</span>
          <h2>{{ t('installer.whatnext') }}</h2>

          <p>
            {{ t('installer.external') }}
            <a
              id="external-link"
              href="https://lauryy06.github.io/Upsilon-External/"
              target="_blank"
              rel="noopener noreferrer"
              >{{ t('installer.gothere') }}</a
            >
          </p>
          <p>
            {{ t('installer.jointhe') }}
            <a
              target="_blank"
              rel="noopener noreferrer"
              href="https://discord.gg/FSnX3tUu"
            >
              {{ t('installer.joinDiscord') }}
            </a>
          </p>
        </div>
        <div class="progressbar" id="progressbar">
          <div class="progressbar-bar" id="progressbar-bar"></div>
        </div>
        <div id="progressbar-text"></div>
      </div>
    </div>
  </div>
</template>

// TODO: Test on the N0100 // TODO: Clean up code

<script>
import { defineComponent } from 'vue'
import { useI18n } from 'vue-i18n'
import Numworks from 'numworks.js'

export default defineComponent({
  name: 'installer',
  setup () {
    const { t } = useI18n({
      inheritLocale: true,
      useScope: 'global'
    })
    return { t }
  },
  mounted: function () {
    this.onload()
  },
  methods: {
    onload () {
      onInstallerLoad(this.t)
    }
  }
})
function onInstallerLoad (t) {
  const installForm = document.getElementById('install-form')
  const connectBtn = document.getElementById('btn-connect')
  const disconnectBtn = document.getElementById('btn-disconnect')
  const installBtn = document.getElementById('btn-install')
  const recoveryBtn = document.getElementById('btn-recovery')
  const restoreCheckbox = document.getElementById('input-restore')
  const progressbar = document.getElementById('progressbar-bar')
  const progressbarText = document.getElementById('progressbar-text')
  const usernameInput = document.getElementById('input-uname')
  const statusDisplay = document.getElementById('status-display')
  const doneMsg = document.getElementById('done-msg')
  const externalLink = document.getElementById('external-link')

  externalLink.onclick = () => {
    calculator.device.device_.close()
  }

  if (!('usb' in navigator)) {
    statusDisplay.innerText = t('installer.incompatibleBrowser')
    statusDisplay.classList = ['error']
    connectBtn.hidden = true
    recoveryBtn.hidden = true
    return
  }

  var storage = null
  var inRecoveryMode = false
  // const releasesList = { '1.0.0': { name: 'U1.0.0' } }
  // const GitHubRepoName = 'Yaya-Cout/Upsilon'
  const language = 'en'
  var shouldRestoreStorage = false
  var calculator = new Numworks()
  var calculatorRecovery = new Numworks.Recovery()
  var currentbin = '' // internal or external

  // Auto connect for the Recovery
  // calculatorRecovery.autoConnect(recovery)

  // Auto connect for install
  calculator.autoConnect(connectedHandler)

  navigator.usb.addEventListener('disconnect', function (e) {
    calculator.onUnexpectedDisconnect(e, function () {
      // Do stuff when the calculator gets disconnected.
      calculator.autoConnect(connectedHandler)
      setStatus('disconnected')
    })
  })

  connectBtn.onclick = (e) => {
    calculator.detect(() => {
      calculator.stopAutoConnect()
      connectedHandler()
    }, onError)
  }

  disconnectBtn.onclick = (e) => {
    e.preventDefault()
    calculator.device.device_.close()
    calculator.stopAutoConnect()
    setStatus('disconnected')
  }

  recoveryBtn.onclick = () => {
    calculatorRecovery.detect(async function () {
      await recovery()
    }, onError)
  }

  installBtn.addEventListener('click', (event) => {
    event.preventDefault()
    install().catch(onError)
  })
  function onError (err) {
    statusDisplay.innerHTML = t('installer.error') + ': ' + err.message
    statusDisplay.classList = ['error']

    if (
      err.message.includes(
        "Cannot set properties of null (setting 'startAddress')"
      )
    ) {
      statusDisplay.innerHTML +=
        '<br> <b>' + t('installer.hints.DisableProtection') + '</b>'
    } else if (err.message.includes('Unable to claim interface')) {
      statusDisplay.innerHTML +=
        '<br> <b>' + t('installer.hints.closeOtherTabs') + '</b>'
    } else if (err.message.includes('No device selected')) {
      statusDisplay.innerHTML +=
        '<br>' +
        t('installer.hints.noDeviceSelected.text1') +
        '<ul style="text-align:left"><li>' +
        t('installer.hints.noDeviceSelected.li1') +
        '</li><li><details><summary>' +
        t('installer.hints.noDeviceSelected.li2') +
        '</summary><details><summary>Linux</summary>' +
        t('installer.hints.noDeviceSelected.driverHint.download') +
        ' <a href="https://workshop.numworks.com/files/drivers/linux/50-numworks-calculator.rules">' +
        t('installer.hints.noDeviceSelected.driverHint.linux.thisfile') +
        '</a> ' +
        t('installer.hints.noDeviceSelected.driverHint.linux.linuxMoveIt') +
        '<br>' +
        t('installer.hints.noDeviceSelected.driverHint.linux.command') +
        '<pre>wget https://workshop.numworks.com/files/drivers/linux/50-numworks-calculator.rules && sudo mv 50-numworks-calculator.rules /etc/udev/rules.d </pre>' +
        '</details><details><summary>Windows</summary>' +
        t('installer.hints.noDeviceSelected.driverHint.download') +
        ' ' +
        t('installer.hints.noDeviceSelected.driverHint.andInstall') +
        ' <a href="https://my.numworks.com/files/drivers/windows/numworks-driver-win64.msi">' +
        t('installer.hints.noDeviceSelected.driverHint.theDriver') +
        '</a> ' +
        t('installer.hints.noDeviceSelected.driverHint.rebootAfter') +
        '</details>' +
        '</details>' +
        '</li></ul><details><summary>' +
        t('installer.hints.noDeviceSelected.moreHelp.needHelp') +
        '</summary>' +
        t('installer.hints.noDeviceSelected.moreHelp.tryRecovery') +
        '<br>' +
        t('installer.hints.noDeviceSelected.moreHelp.1') +
        ' <a target="_blank" rel="noopener noreferrer" href="https://discord.gg/FSnX3tUu">' +
        t('installer.hints.noDeviceSelected.moreHelp.discord') +
        '</a> ' +
        t('installer.hints.noDeviceSelected.moreHelp.2') +
        '</details>'
    }
  }
  function setStatus (status) {
    console.log('Status set to', status)
    switch (status) {
      case 'connected':
        console.log('Calculator connected')
        if (inRecoveryMode) {
          statusDisplay.innerHTML = t('installer.recoveryConnected')
        } else {
          statusDisplay.innerHTML = t('installer.connected')
        }

        statusDisplay.classList = ['info']
        installForm.hidden = false
        recoveryBtn.hidden = true
        connectBtn.hidden = true
        doneMsg.hidden = true

        break
      case 'disconnected':
        if (statusDisplay.innerHTML === t('installer.waitingForReboot')) return
        console.log('Calculator disconnected')
        statusDisplay.innerHTML = t('installer.disconnected')
        statusDisplay.classList = ['disconnected']
        installForm.hidden = true
        recoveryBtn.hidden = false
        connectBtn.hidden = false
        doneMsg.hidden = true

        break
      case 'backingup':
        statusDisplay.innerHTML = t('installer.backingup')
        statusDisplay.classList = ['info']
        progressbar.hidden = false
        installForm.hidden = true
        recoveryBtn.hidden = true
        connectBtn.hidden = true
        doneMsg.hidden = true

        break
      case 'downloading':
        statusDisplay.innerHTML =
          t('installer.downloading') +
          (currentbin === 'external' ? ' 1' : ' 2') +
          '/2 ...'
        statusDisplay.classList = ['info']
        break
      case 'erasing':
        statusDisplay.innerHTML =
          t('installer.erasing') +
          (currentbin === 'external' ? ' 1' : ' 2') +
          '/2 ...'
        statusDisplay.classList = ['info']
        break
      case 'copying':
        statusDisplay.innerHTML =
          t('installer.writing') +
          (currentbin === 'external' ? ' 1' : ' 2') +
          '/2 ...'
        statusDisplay.classList = ['info']
        break
      case 'waitingForReboot':
        statusDisplay.innerHTML = t('installer.waitingForReboot')
        statusDisplay.classList = ['info']
        break
      case 'downloadingN100':
        statusDisplay.innerHTML = t('installer.downloading') + '...'
        statusDisplay.classList = ['info']
        break
      case 'installingN100':
        statusDisplay.innerHTML = t('installer.installing')
        statusDisplay.classList = ['info']
        break
      case 'installationDone':
        statusDisplay.innerHTML = t('installer.done')
        statusDisplay.classList = ['info']
        installForm.hidden = true
        doneMsg.hidden = false
        break
      case 'restoring':
        statusDisplay.innerHTML = t('installer.restoring')
        statusDisplay.classList = ['info']
        break
      case 'downloadingRecovery':
        statusDisplay.innerHTML = t('installer.downloadingRecovery')
        statusDisplay.classList = ['info']
        break
      case 'installingRecovery':
        statusDisplay.innerHTML = t('installer.installingRecovery')
        statusDisplay.classList = ['info']
        break
      case 'recoveryDone':
        statusDisplay.innerHTML = t('installer.recoveryDone')
        statusDisplay.classList = ['info']
        break
      default:
        throw new Error('Invalid status specified')
    }
  }
  function logInfo (text) {
    if (text === 'Erasing DFU device memory') {
      setStatus('erasing')
    } else if (text === 'Copying data from browser to DFU device') {
      setStatus('copying')
    }
    if (process.env.NODE_ENV !== 'production') {
      console.log(text)
    }
  }
  async function install () {
    // Install Upsilon on the calculator
    try {
      await initInstall()
      const model = calculator.getModel()
      console.log('Model : ' + model)
      if (model === '0100') {
        setStatus('downloadingN100')
        downloadBin('internal', 'N0100').then((bin) => {
          setStatus('installingN100')
          patchUsername(bin)
          calculator.flashInternal(bin).catch(onError)
        })
      } else if (model === '0110') {
        currentbin = 'external'
        setStatus('downloading')

        await downloadBin('external', 'N0110').then(async (bin) => {
          await calculator.flashExternal(bin)
        })
        console.log('downloading internal')
        currentbin = 'internal'
        setStatus('downloading')
        logProgress(0, 1)
        await downloadBin('internal', 'N0110').then(async (bin) => {
          patchUsername(bin)
          await calculator.flashInternal(bin)
        })
      } else console.error('Model not supported: ' + model)

      setStatus('waitingForReboot')
      inRecoveryMode = false
      await postInstall()
      inRecoveryMode = false
    } catch (error) {
      await errorHandler(error)
    }
  }

  async function recovery () {
    // Flash Upsilon's recovery on the calculator
    try {
      calculatorRecovery.stopAutoConnect()
      inRecoveryMode = true
      connectedHandler()
      await initInstall()
      const model = calculatorRecovery.getModel()
      console.log('Model : ' + model)
      console.log('Downloading flasher')
      setStatus('downloadingRecovery')
      const flasher = await downloadBin('flasher', 'N' + model)
      console.log('Flashing flasher')
      setStatus('installingRecovery')
      await calculatorRecovery.flashRecovery(flasher)
      console.log('Recovery flashed successfully')
      await postInstall()
      setStatus('recoveryDone')
    } catch (error) {
      await errorHandler(error)
    }
  }

  async function connectedHandler () {
    // Do stuff when the calculator gets connected.
    setTimeout(() => {
      setStatus('connected')
    }, 0)
    if (!inRecoveryMode) {
      const PlatformInfo = await calculator.getPlatformInfo()
      console.log('PlatformInfo :', PlatformInfo)
      if (PlatformInfo.omega.user) {
        console.log(
          'Setting username input value to ' + PlatformInfo.omega.user
        )
        usernameInput.value = PlatformInfo.omega.user
      }
    }
    if (shouldRestoreStorage && !inRecoveryMode) {
      if (!restoreCheckbox.checked) {
        setTimeout(() => {
          setStatus('installationDone')
        }, 0)
        shouldRestoreStorage = false
        return
      }
      console.log('Restoring storage', shouldRestoreStorage)
      await calculator.installStorage(storage, function () {
        console.log('Storage restored successfully')
        setStatus('installationDone')
      })
      shouldRestoreStorage = false
    }
  }

  function logProgress (done, total) {
    const percentage = (done / total) * 100
    progressbar.style.width = percentage + '%'
    progressbarText.textContent = percentage.toFixed() + '%'
  }

  async function hash (blob) {
    // Hash blob file
    const msgUint8 = await blob.arrayBuffer()
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8)
    const hashArray = Array.from(new Uint8Array(hashBuffer))
    return hashArray.map((b) => b.toString(16).padStart(2, '0')).join('')
  }

  async function getDownloadURL (jsonUrl) {
    return fetch(jsonUrl).then((response) => {
      return response.json().then((json) => {
        return jsonUrl + '?alt=media&token=' + json.downloadTokens
      })
    })
  }
  async function downloadBin (name, model) {
    // Function to download binary file that will be flashed on the calculator
    const mirror =
      'https://firebasestorage.googleapis.com/v0/b/upsilon-binfiles.appspot.com/o/'
    const release = 'dev'
    const maxDownloads = 2
    let fwname = 'epsilon.onboarding.' + name + '.bin'
    model = model.toLowerCase()
    if (model === 'n0100') {
      fwname = 'epsilon.onboarding.' + name + '.' + language + '.bin'
    }
    if (name === 'flasher') {
      fwname = 'flasher.verbose.bin'
    }
    const jsonUrl = `${mirror}${release}%2F${
      model === 'n0100' ? 'n100' : 'n110'
    }%2F${fwname}`
    const binUrl = await getDownloadURL(jsonUrl)
    const shaUrl = await getDownloadURL(jsonUrl + '.sha256')

    // Download bin file
    for (var i = 0; i < maxDownloads; i++) {
      console.log('Downloading ' + fwname)
      const bin = await downloadAsync('GET', binUrl, 'blob')
      // Verify download
      console.log('Downloading checksum')
      const checksum = await downloadAsync('GET', shaUrl, 'text')
      console.log('Hashing bin file')
      let binHashed = null
      if (model === 'n0100') {
        binHashed = (await hash(bin)) + ' *final-output/' + fwname + '\n'
      } else {
        binHashed = (await hash(bin)) + ' *binpack/' + fwname + '\n'
      }
      console.log('Verifying checksum')
      if (checksum === binHashed) {
        // If download is verified, return the downloaded bin file
        console.log('Bin file downloaded successfully')
        return await bin.arrayBuffer()
      } else {
        // If download is errored, retry the download
        console.log('Download failed')
        console.log('Checksum: ' + checksum + ', Bin hash: ' + binHashed)
        throw new Error({ message: 'Failed to verify file integrity' })
      }
    }
    throw new Error('Download failed after ' + i + ' tr' + i > 1 ? 'ies' : 'y')
  }

  async function downloadAsync (method, url, responseType = 'blob') {
    return fetch(url, { method: method }).then((response) => {
      if (responseType === 'blob') {
        return response.blob()
      } else {
        return response.text()
      }
    })
  }

  async function initInstall () {
    // Function to setup the installation
    if (inRecoveryMode) {
      calculatorRecovery.device.logProgress = logProgress
    }
    try {
      calculator.device.logProgress = logProgress
    } catch (err) {
      if (!inRecoveryMode) {
        console.warn('Error when initializing the progress bar')
      }
    }
    try {
      // Disable WebDFU logging in production
      if (process.env.NODE_ENV === 'production') {
        calculator.device.logDebug = () => {}
      }
      calculator.device.logInfo = logInfo
    } catch (e) {
      console.warn('Error while disabling WebDFU logging')
    }
    progressbar.parentNode.classList.add('progressbar-active')
    console.log('Calculator object:', calculator.device)

    setStatus('backingup')
    try {
      storage = await calculator.backupStorage()
      // Ditch all non-python stuff, for convinience.
      for (var i in storage.records) {
        if (storage.records[i].type !== 'py') storage.records.splice(i, 1)
      }
      console.log('Storage :', storage)
    } catch (e) {
      if (storage == null) {
        storage = new DataView(new ArrayBuffer())
        console.warn(
          'Error when fetching scripts, creating a new empty storage'
        )
      } else {
        console.log('Error when fetching scripts, kepping old scripts')
      }
    }
    logProgress(0, 1)
    console.log('Disabling protection')
    if (!inRecoveryMode) {
      try {
        await calculator.device.requestOut(11)
      } catch (e) {
        console.log("Couldn't disable protection")
      }
    }
  }

  async function postInstall () {
    // Function to finish the installation cleanly.
    shouldRestoreStorage = true
    progressbar.parentNode.classList.remove('progressbar-active')
    progressbarText.hidden = true
    recoveryBtn.hidden = false
    connectBtn.hidden = false
  }

  function patchUsername (InternalBin) {
    // Function to patch the internal bin with the username.
    const username = usernameInput.value
    console.log('Patching internal bin with username : ' + username)
    if (username) {
      const internalBuf = new Uint8Array(InternalBin)

      const enc = new TextEncoder()
      let encoded = enc.encode(username + '\0')
      if (encoded.length > 16) {
        encoded[15] = 0
        encoded = encoded.slice(0, 16)
      }
      internalBuf.set(encoded, 0x1f8)
    }
  }
  async function errorHandler (error) {
    console.error(error)
    // installationFail.hidden = false
    await postInstall()
    // installationSuccess.hidden = true
  }
}
</script>
<style>
details {
  text-align: justify;
}
summary {
  user-select: none;
  cursor: pointer;
}
details details {
  margin-left: 10px;
}
pre {
  overflow-x: scroll;
}
pre::-webkit-scrollbar {
  height: 5px;
}
pre::-webkit-scrollbar-track {
  background: var(--error-bg);
}
pre::-webkit-scrollbar-thumb {
  background: var(--error-text);
  border-radius: 5pt;
}
</style>
<style scoped>
#thanks {
  font-size: 1.1em;
}
p {
  text-align: justify;
  padding-left: 1.5em;
  padding-right: 1.5em;
  font-size: 1.1em;
}
h1 {
  margin: 0.5em;
  padding: 0.5em;
}
.error {
  background-color: var(--error-bg);
  border: red 1pt solid;
  color: var(--error-text);
  backdrop-filter: blur(50px);
  padding: 1em;
  margin: 1em;
}
.info {
  background-color: var(--feature-bg-upsilon);
  border: solid var(--upsilon-1) 1pt;
  backdrop-filter: blur(50px);
  padding: 1em;
  margin: 1em;
}

.disconnected {
  background-color: var(--feature-bg-omega);
  border: solid var(--error-text) 1pt;
  backdrop-filter: blur(50px);
  padding: 1em;
  margin: 1em;
}
#status-display {
  transition: all 0.1s;
  border-radius: 5px;
}
.progressbar {
  height: 8px;
  border-radius: 10px;
  background-color: var(--foreground-2);
  margin: 15px;
  opacity: 0;
  overflow: hidden;
}
.progressbar-active {
  opacity: 1;
}
.progressbar-bar {
  height: 8px;
  background-color: var(--upsilon-1);
}

button {
  border-radius: 5px;
  background-color: var(--upsilon-1);
  border: none;
  color: white;
  padding: 16px 32px;
  text-align: center;
  text-decoration: none;
  font-size: 16px;
  margin: 12px 6px;
  transition-duration: 0.4s;
  cursor: pointer;
  user-select: none;
}
#btn-disconnect {
  background-color: var(--feature-bg-omega);
  border: solid var(--error-text) 1pt;
  backdrop-filter: blur(50px);
  color: var(--foreground);
}
#btn-disconnect:hover {
  background-color: var(--error-text);
  border: solid var(--error-text) 1pt;
  color: var(--upsilon-2);
}
#btn-connect,
#btn-install {
  background-color: var(--upsilon-2);
  color: var(--foreground);
  border: 2px solid var(--upsilon-1);
}

#btn-connect:hover,
#btn-install:hover {
  background-color: var(--upsilon-1);
  color: var(--upsilon-2);
}

#btn-recovery {
  background-color: var(--upsilon-2);
  color: var(--foreground);
  border: 2px solid var(--foreground-2);
}

#btn-recovery:hover {
  background-color: var(--foreground-2);
  color: var(--upsilon-2);
}

.textinput {
  border: 2px solid var(--upsilon-1); /* FIXME */
  border-radius: 5px;
  background-color: var(--upsilon-2);
  color: var(--foreground);
  padding: 16px 0px;
  text-align: center;
  text-decoration: none;
  font-size: 16px;
  margin: 4px 2px;
  transition-duration: 0.4s;
}

.installer {
  text-align: center;
}

.installationMessage {
  font-size: 20px;
}

#installer {
  padding: 1em;
  display: flex;
  justify-content: center;
  align-items: baseline;
}

#install-form {
  display: grid;
  grid-template-columns: auto auto;
  max-width: 400px;
  margin: auto;
  padding: 1em;
  border-radius: 5px;
}
#install-form > * {
  display: block;
}
label {
  user-select: none;
}
#install-form > label,
#install-form > input {
  text-align: left;
  margin: 0.5em;
  font-size: 1.1em;
  padding: 0.5em;
}
input {
  background-color: var(--upsilon-2);
  border: solid var(--upsilon-1) 2pt;
  border-radius: 3px;
  color: var(--foreground);
  font-family: inherit;
}

*[hidden] {
  display: none !important;
}
</style>
